# 委派攻击

  
  
&lt;!--more--&gt;  
## 0x00 什么是委派？  
委派是大型网络中经常部署的应用模式，给多跳认证带来了很大的便利，与此同时也带了很大的安全隐患。利用委派，攻击者可结合其他漏洞进行组合攻击，导致攻击者可以获取本地管理员甚至域管理员的权限，还可以制作隐藏的后门。  
委派是指将域内用户的权限委派给服务账户，使得服务账户能以用户权限访问域内的其他服务。  
在域中，只有主机账户和服务账户才具有委派属性。  
主机账户就是活动目录Computers中的计算机，也可以称为机器账户。  
服务账户是域内用户账户的一种类型，是将服务运行起来并加入域时所用的账户。例如，SQL Server在安装时会在域内自动注册服务账户SQLServiceAccount，也可以将域用户通过注册SPN变为服务账户。  
### 0x01 委派的类型  
域内委派主要有3种类型  
- 非约束性委派  
- 约束性委派  
- 基于资源的约束性委派  
### 非约束性委派  
在Windows Server2000首次发布Active Directory，微软就提供了一种简单的机制来支持用户通过Kerberos向Web服务器进行身份验证，用户通过该机制可以更新后端数据库服务器上的记录。这就是最早的非约束性委派。对于非约束性委派，服务账户可以获取被委派用户的TGT，并将TGT缓存到LSASS进程中，从而服务账户可以使用该TGT模拟该用户访问任意服务。非约束性委派的设置需要`SeEnableDelegationPrivilege`特权，该特权默认仅授予域管理员和企业管理员。  
### 约束性委派  
由于非约束性委派的不安全性，微软在Windows Server 2003中发布了约束性委派。对于约束性委派，服务账户只能获取该用户对指定服务的ST，从而只能模拟该用户访问特定的服务。配置了约束性委派账户的`msDS-AllowedToDelegateTo`属性会指定对哪个SPN进行委派。约束性委派的设置需要`SeEnableDelegationPrivilege`特权，该特权默认仅授予域管理员和企业管理员。  
约束性委派有两种：一种是仅使用Kerberos，也就是不能进行协议转换；另一种是使用任何身份验证协议，也就是说能进行协议转换。  
#### 仅使用Kerberos  
配置了仅使用Kerberos约束性委派的机器账户和服务账务的`userAccountControl`属性与正常账户一样，但是其`msDS-AllowedTodelegateTo`属性会有允许被委派服务的SPN。  
#### 使用任何身份验证协议  
配置了使用任何身份验证协议约束性委派的机器账户和服务账户`userAcccountControl`属性的`Flag`位不一致，其`msDS-AllowedToDelegateTo`属性会有允许被委派服务的`SPN`  
#### 约束性委派流程  
为了在Kerberos协议层面对约束性委派进行支持，微软对Kerberos协议扩展了两个自协议`S4USelf(Service for User to Self)`和`S4u2Proxy(Service for User to Proxy)`。`S4uSelf`可以代表任意用户请求针对自身的`ST`；`S4u2Proxy`可以用上一步获得的`ST`以用户名义请求针对指定服务的`ST`。  
#### S4uSelf  
S4uSelf,当用户以其他方式如NTLM认证、基于表单的认证等与Web服务进行认证后，无法向Web服务器提供请求服务的ST，因此服务器也无法进一步使用S4u2Proxy协议请求访问服务B  
S4uSelf协议便是解决该问题的方案，被配置为约束性委派的服务账户能够调用S4uSelf协议向KDC申请为任意用户请求访问自身的可转发的ST。  
#### Seu2Proxy  
S4u2Proxy，S4u2Proxy可以用上一步获得的可转发ST以用户的名义请求针对其他指定服务的ST。S4u2Proxy使得服务A可以使用来自用户test得授权，然后以用户test得身份向KDC请求访问服务B的ST。需要说明的是，服务使用S4u2Proxy协议代表用户获得针对服务自身ST的过程是不需要用户凭据的。  
### 基于资源的约束性委派  
为了使用户和资源更加独立，微软在Windows Server 2012中引入了基于资源的约束性委派。基于资源的约束性委派不需要域管理员权限去设置，而是把设置属性的权限赋予了机器自身。基于资源的约束性委派允许受信任的账户委派给自身。基于资源的约束性委派只能在运行Windows Server 2012和Windows Server 2012 R2及以上的域控上进行配置，但可以在混合模式的林中应用。配置了基于资源的约束性委派账户的`msDS-AllowedToActOnBehalfOfOtherIdentity`属性的值为被允许委派账户的SID。  
#### 基于资源的约束性委派流程  
整个流程如下：  
1、服务A使用自己的服务账户和密码向KDC申请一个可转发的TGT。  
2、服务A利用S4u2Self协议代表用户申请一个访问自身的ST。这一步区别于传统的约束性委派。在S4u2Self协议中提到，返回的ST可转发的一个条件是服务A配置了传统的约束性委派。KDC会检查服务A的`msDS-AllowedToDelegateTo`字段，如果这个字段被赋值了，则KDC返回可转发的ST。但是由于这里是基于资源的约束性委派，是在服务B上配置的，服务B的`msDS-AllowedToActOnBehaltOfOtherIdentity`属性配置了服务A的SID，服务A并没有配置`msDS-AllowedToDelegateTo`字段，因此KDC返回的ST是不可转发的。  
3、服务A利用S4u2Proxy协议以用户的身份向KDC请求访问服务B的可转发的ST。KDC返回访问服务B的可转发的ST。  
#### 约束性委派和基于资源的约束性委派配置的差别  
传统的约束性委派是正向的，通过修改服务账户的`msDS-AllowedToDelegateTo`属性，添加服务B的SPN，设置约束性委派对象为服务B，服务A便可以模拟任意用户向域控请求访问服务B的ST。  
而基于资源的约束性委派则相反，通过修改服务B的`msDS-AllowedToActOnBehalfOfOtherIdentity`属性，添加服务A的SID，以达到让服务A模拟任意用户访问服务B资源的目的。  
#### 基于资源的约束性委派攻击  
在基于资源的约束性委派的过程中，不可转发的ST仍然可以通过S4u2Proxy协议转发到其他服务起进行委派认证，并且服务还会返回可转发的ST，这是微软设计缺陷。  
因此，如果能构造服务B上配置允许服务A的基于资源的约束性委派，那么可以通过控制服务A使用S4u2Self协议去向域控请求任意用户访问自身的ST，最后再使用S4u2Proxy协议转发此ST去请求访问服务B的可转发的ST，我们就可以模拟任意用户访问服务B了。而我们这里控制的服务A可以以普通域用户的身份去创建机器账户。  
要想进行基于资源的约束性委派攻击，需要具备以下两个条件：  
拥有服务A的权限，这里只需要拥有一个普通的域账户权限即可，因为普通的域账户默认可以创建最多10个机器账户，机器账户可以作为服务账户使用。  
拥有在服务B上配置允许服务A的基于资源的约束性委派的权限，即拥有修改服务B的`msDS-AllowedToActOnBehalfOfOtherIdentity`属性的权限。机器账户自身和创建机器账户的用户即拥有该权限。  
  

---

> Author: N1Rvana  
> URL: https://nlrvana.github.io/%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/  

